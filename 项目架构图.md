# 项目架构图

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    entry.py (入口)                       │
│                  启动应用 → 登录 → 主窗口                  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              MainWindow (主窗口控制器)                    │
│  - 管理所有页面实例                                        │
│  - 存储共享数据 (dataset_path, model_pkl_path)           │
│  - 处理页面间通信                                          │
└─────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
   ┌─────────┐        ┌─────────┐        ┌─────────┐
   │ Page 1  │        │ Page 3  │        │ Page 4  │
   │ (View)  │        │ (View)  │        │ (View)  │
   └────┬────┘        └────┬────┘        └────┬────┘
        │                  │                  │
        ↓                  ↓                  ↓
   ┌─────────┐        ┌─────────┐        ┌─────────┐
   │Handler 1│        │Handler 3│        │Handler 4│
   │(Logic)  │        │(Logic)  │        │(Logic)  │
   └────┬────┘        └────┬────┘        └────┬────┘
        │                  │                  │
        ↓                  ↓                  ↓
   ┌─────────┐        ┌─────────┐        ┌─────────┐
   │ Worker  │        │ Worker  │        │ Worker  │
   │(Async)  │        │(Async)  │        │(Async)  │
   └────┬────┘        └────┬────┘        └────┬────┘
        │                  │                  │
        ↓                  ↓                  ↓
   ┌─────────┐        ┌─────────┐        ┌─────────┐
   │Apriori  │        │Bayesian │        │Predict  │
   │(Core)   │        │(Core)   │        │(Core)   │
   └─────────┘        └─────────┘        └─────────┘
```

## 📁 文件夹结构

```
pyqt_apriori/
├── entry.py                    # 程序入口
├── view/                       # 视图层
│   ├── main_window.py         # 主窗口控制器
│   ├── login_window/          # 登录窗口
│   └── pages/                 # 功能页面
│       ├── page_one.py        # 数据导入页面 (View)
│       ├── page_one_handler.py # 数据导入业务逻辑 (Handler)
│       ├── page_two.py        # Apriori规则挖掘页面 (View)
│       ├── page_two_handler.py # 规则挖掘业务逻辑 (Handler)
│       ├── page_3.py          # 贝叶斯网络构建页面 (View)
│       ├── page_3_handler.py  # 贝叶斯网络业务逻辑 (Handler)
│       ├── page_4.py           # 故障预测评估页面 (View)
│       ├── page_4_handler.py  # 故障预测业务逻辑 (Handler)
│       ├── page_5.py           # 数据可视化页面 (View)
│       └── page_5_handler.py   # 数据可视化业务逻辑 (Handler)
├── ui_page/                    # UI定义层
│   ├── page_one.ui            # Page 1 的 Qt Designer 文件
│   ├── page_two.ui            # Page 2 的 Qt Designer 文件
│   ├── page_3.ui              # Page 3 的 Qt Designer 文件
│   ├── page_4.ui              # Page 4 的 Qt Designer 文件
│   ├── page_5.ui              # Page 5 的 Qt Designer 文件
│   ├── ui_page_one.py         # 由 page_1.ui 生成的 Python 代码
│   ├── ui_page_two.py         # 由 page_2.ui 生成的 Python 代码
│   ├── ui_page_3.py           # 由 page_3.ui 生成的 Python 代码
│   ├── ui_page_4.py           # 由 page_4.ui 生成的 Python 代码
│   └── ui_page_5.py           # 由 page_5.ui 生成的 Python 代码
├── workers/                    # 异步任务层
│   ├── TaskManager.py         # 任务管理器 (QRunnable封装)
│   ├── apriori_worker.py      # Apriori算法异步任务
│   ├── bayesian_worker.py     # 贝叶斯网络构建异步任务
│   └── prediction_worker.py   # 预测任务异步处理
├── apriori/                    # Apriori算法模块
│   ├── apriori1.py            # Apriori算法核心实现
│   └── equipment_analyzer.py  # 设备分析器
├── new_bayesian/              # 贝叶斯网络模块
│   ├── BN_new/                # 贝叶斯网络构建
│   │   └── bn_bayesian.py     # 核心类: BayesianNetwork
│   ├── predict/               # 预测模块
│   │   └── predict.py         # 预测核心实现
│   ├── dataset/               # 数据集目录
│   ├── pkl/                    # 模型文件目录
│   └── result/                 # 结果输出目录
├── common/                     # 通用工具库
│   ├── config.py              # 配置管理 (读写 config.json)
│   ├── utils.py               # 通用工具函数
│   ├── my_logger.py           # 日志系统
│   └── aes.py                 # AES加密模块
├── components/                 # 自定义组件库
│   ├── bar.py                 # 自定义进度条
│   ├── icon.py                # 图标管理
│   ├── label_widget.py        # 自定义标签
│   └── log_dialog.py          # 日志对话框
└── resource/                   # 资源文件目录
    ├── images/                # 图片资源
    ├── i18n/                  # 国际化文件
    └── qss/                   # 样式表
```

## 🔄 数据流向

```
Page 1 (数据导入)
   ↓ file_selected 信号
MainWindow.on_file_path_changed()
   ↓ 保存 dataset_path
   
Page 2 (Apriori规则挖掘)
   ↓ 读取 MainWindow.dataset_path
   ↓ 执行 Apriori 算法
   ↓ initial_rules_ready 信号
MainWindow.on_initial_rules_ready()
   ↓ 保存 initial_rules_df
   ↓ optimized_rules_ready 信号
MainWindow.on_optimized_rules_ready()
   ↓ 保存 optimized_rules_df

Page 3 (贝叶斯网络构建)
   ↓ 读取 MainWindow.dataset_path
   ↓ 构建并训练贝叶斯网络
   ↓ 保存模型到 MainWindow.model_pkl_path
   ↓ 保存 (model, bin_config) 到 .pkl 文件

Page 4 (故障预测)
   ↓ 读取 MainWindow.model_pkl_path
   ↓ 加载 (model, bin_config)
   ↓ 执行预测
   └── 显示结果
```

## 🎯 关键设计模式

### 1. MVC 模式
- **Model**: 核心算法层 (apriori/, new_bayesian/)
- **View**: 视图层 (view/pages/*.py)
- **Controller**: Handler层 (view/pages/*_handler.py)

### 2. Handler 分层架构
```python
# View 只负责界面
class Page4(QWidget, Ui_page_4):
    def __init__(self):
        self.handler = PageFourHandler(self)
        self.bind_event()
    
    def bind_event(self):
        self.pushButton_solely.clicked.connect(
            self.handler.assess_single_instance
        )

# Handler 负责业务逻辑
class PageFourHandler(QObject):
    def assess_single_instance(self):
        # 收集数据
        # 调用 Worker
        # 处理回调
```

### 3. 异步任务模式
```python
# 创建线程和Worker
self.thread = QThread()
self.worker = PredictionWorker(model_path, data)
self.worker.moveToThread(self.thread)

# 连接信号
self.thread.started.connect(self.worker.run)
self.worker.finished.connect(self.on_finished)

# 启动线程
self.thread.start()
```

### 4. Signal/Slot 通信
```python
# 页面间通信
class PageOne(QWidget):
    file_selected = Signal(str)  # 定义信号
    
    def select_file(self):
        self.file_selected.emit(file_path)  # 发射信号

class MainWindow(FluentWindow):
    def __init__(self):
        self.pageOne.file_selected.connect(
            self.on_file_path_changed  # 连接槽函数
        )
```

## 🔑 核心文件说明

### 最重要的文件
1. **entry.py**: 程序入口
2. **view/main_window.py**: 主窗口，管理所有页面和共享数据
3. **view/pages/page_4_handler.py**: Page4业务逻辑
4. **workers/prediction_worker.py**: 预测异步任务
5. **new_bayesian/predict/predict.py**: 预测核心算法
6. **new_bayesian/BN_new/bn_bayesian.py**: 贝叶斯网络训练

### 配置文件
- **config.json**: 用户配置 (主题、语言、自动登录等)
- **requirements.txt**: Python依赖包

## 📝 开发建议

### 修改界面
1. 使用 Qt Designer 编辑 `ui_page/*.ui`
2. 运行 `python pack_resources.py`
3. 在对应的 `view/pages/*.py` 中使用

### 添加新功能
1. 在 Handler 中添加业务逻辑
2. 如需异步处理，创建 Worker
3. 通过 Signal/Slot 更新界面

### 调试技巧
- 查看控制台输出 (print/logger)
- 检查 `logs/` 目录下的日志文件
- 使用 DEBUG 标记追踪数据流
